
/* ESP.EE v7 ‚Äî Consolidado r6 */
const SITE_ID='esparedes-my.sharepoint.com,540a0485-2578-481e-b4d8-220b41fb5c43,7335dc42-69c8-42d6-8282-151e3783162d';
const CFG_PATH='/Documents/GestaoAlunos-OneDrive/config_especial.json';
const REG_PATH='/Documents/GestaoAlunos-OneDrive/2registos_alunos.json';
const BACKUP_FOLDER='/Documents/GestaoAlunos-OneDrive/backup';
const ALLOWLIST=['biblioteca@esparedes.pt'];
const ESCOLA_TIMES=['08:15-09:05','09:10-10:00','10:15-11:05','11:15-12:05','12:10-13:00','13:05-13:55','14:00-14:50','15:00-15:50','16:05-16:55','17:00-17:50'];
const DIAS=['Segunda','Ter√ßa','Quarta','Quinta','Sexta'];

let msalApp,account,accessToken; const state={config:{professores:[],alunos:[],disciplinas:[],oficinas:[],calendario:{}},reg:{versao:'v2',registos:[]},adminSel:{entity:'professores',index:-1}}; state._wb=null; state._wbName='';
const $=s=>document.querySelector(s);
function esc(v){return String(v??'').replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[m]));}
function toast(t){try{Swal.fire({toast:true,position:'top-end',timer:1600,showConfirmButton:false,title:t});}catch{}}
function todayISO(){ const d=new Date(); const pad=n=>String(n).padStart(2,'0'); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function getEmail(){return (account?.username??'').trim().toLowerCase();}

const RX_PROF_ID = /^\d{3}[A-Z]{2}\d{2}$/;                  // professor (ex.: 910EE07)
const RX_ALUNO   = /^(?:\d[A-Z]\d+|\d{3})$/;               // 9C1, 8J6, 811, ...
const STUDENT_LIKE = new Set(['CJ','Boccia','Natacao','SNZ']); // aluno/servi√ßo (tem n¬∫ li√ß√£o)
const SERVICE_ONLY = new Set(['CA','PM','PEI','TP','APEE','DT','AP','BE','Desporto','GestPr']); // servi√ßo puro

function isAdmin(){ const email=getEmail(); if(!email) return false; const cfg=state.config?.professores??[]; if(!Array.isArray(cfg)) return false; if(ALLOWLIST.includes(email)) return true; const p=cfg.find(x=>(x.email??'').toLowerCase()===email); const ok=p && String(p.role??'').toLowerCase()==='admin' && email.endsWith('@esparedes.pt'); return !!ok; }

const MSAL_CONFIG={auth:{clientId:'c5573063-8a04-40d3-92bf-eb229ad4701c',authority:'https://login.microsoftonline.com/d650692c-6e73-48b3-af84-e3497ff3e1f1',redirectUri:(location.origin + location.pathname.replace(/index\.html$/,''))},cache:{cacheLocation:'localStorage',storeAuthStateInCookie:false}};
const MSAL_SCOPES={scopes:['Files.ReadWrite.All','User.Read','openid','profile','offline_access']};
async function initMsal(){ if(typeof msal==='undefined')return; msalApp=new msal.PublicClientApplication(MSAL_CONFIG); try{ const r=await msalApp.handleRedirectPromise(); if(r?.account){account=r.account; msalApp.setActiveAccount(account);} const accs=msalApp.getAllAccounts(); if(accs.length&&!account){account=accs[0]; msalApp.setActiveAccount(account);} }catch(e){console.warn('msal init',e);} updateAuth(); }
async function acquire(){ try{ const r=await msalApp.acquireTokenSilent(MSAL_SCOPES); accessToken=r.accessToken; return accessToken; }catch{ await msalApp.acquireTokenRedirect(MSAL_SCOPES);} }
function doLogin(){ msalApp?.loginRedirect(MSAL_SCOPES); }
async function doLogout(){ try{ const acc=msalApp.getActiveAccount(); localStorage.removeItem('esp_config'); localStorage.removeItem('esp_reg'); await msalApp.logoutRedirect({account:acc}); }catch(e){} }

async function gLoad(path){ if(!accessToken) await acquire(); const r=await fetch(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drive/root:${path}:/content`,{headers:{Authorization:`Bearer ${accessToken}`}}); if(r.ok){ const t=await r.text(); return t?JSON.parse(t):null } return null }
async function gSave(path,obj){ if(!accessToken) await acquire(); const r=await fetch(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drive/root:${path}:/content`,{method:'PUT',headers:{Authorization:`Bearer ${accessToken}`,'Content-Type':'application/json; charset=utf-8'},body:JSON.stringify(obj,null,2)}); if(!r.ok) throw new Error('save '+r.status); return await r.json(); }
function pdir(p){const i=p.lastIndexOf('/'); return i>0? p.slice(0,i):'/'; }
async function ensureFolder(folder){ if(!accessToken) await acquire(); const clean=(folder??'').replace(/^\/+|\/+$/g,''); if(!clean) return; const parts=clean.split('/'); let cur=''; for(const seg of parts){ cur+='/'+seg; const chk=await fetch(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drive/root:${cur}`,{headers:{Authorization:`Bearer ${accessToken}`}}); if(chk.status===404){ const parent=cur.substring(0,cur.lastIndexOf('/'))||'/'; await fetch(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drive/root:${parent}:/children`,{method:'POST',headers:{Authorization:`Bearer ${accessToken}`,'Content-Type':'application/json'},body:JSON.stringify({name:seg,folder:{},"@microsoft.graph.conflictBehavior":"replace"})}); } } }
async function gSaveWithParents(path,obj){ await ensureFolder(pdir(path)); return await gSave(path,obj); }

async function loadAll(){ setSync('üîÅ sincronizando...'); const cfg=await gLoad(CFG_PATH); if(cfg && Array.isArray(cfg.professores)) state.config=cfg; const reg=await gLoad(REG_PATH); if(reg && Array.isArray(reg.registos)) state.reg=reg; localStorage.setItem('esp_config',JSON.stringify(state.config)); localStorage.setItem('esp_reg',JSON.stringify(state.reg)); setSync('üíæ guardado'); updateAuth(); renderAdminGrid(); renderProfessor(); diag(); }
function setSync(t){ const el=$('#syncIndicator'); if(el) el.textContent=t; }

function updateAuth(){ const email=getEmail(); const prof=(state.config.professores??[]).find(p=>(p.email??'').toLowerCase()===email); const banner=$('#profBanner'); banner && (banner.textContent = account?`Sess√£o: ${(account.name??account.username)}${prof?` ‚Ä¢ ${prof.id} ¬∑ ${prof.nome}`:''}`:'Sess√£o: n√£o iniciada'); $('#btnMsLogin')?.classList.toggle('hidden',!!account); $('#btnMsLogout')?.classList.toggle('hidden',!account); const admin=isAdmin(); $('#admin')?.classList.toggle('hidden',!admin); $('#secExportBackup')?.classList.toggle('hidden',!admin); $('#secProfessor')?.classList.toggle('hidden',!account); }

// ===== Excel helpers (XLSX) =====
async function loadWorkbook(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload=()=>{ try{ const data=new Uint8Array(fr.result); const wb=XLSX.read(data,{type:'array'}); resolve(wb); }catch(e){ reject(e);} }; fr.onerror=reject; fr.readAsArrayBuffer(file); }); }
function sheetBy(wb,names){ for(const n of names){ if(wb.Sheets[n]) return {name:n,ws:wb.Sheets[n]}; } return null; }
function rowsFrom(ws){ return XLSX.utils.sheet_to_json(ws,{defval:'',raw:false}); }
function guessCol(obj, aliases){ for(const k in obj){ const key=k.trim().toLowerCase(); for(const a of aliases){ if(key===a.toLowerCase()) return k; } } return null; }
function setWbLoaded(on){ ['btnWbInfo','btnImpProf','btnImpAlu','btnImpDisc','btnImpAulas','btnGenProf','btnGenAlu','btnGenDisc','btnGenAulas'].forEach(id=>{ const el=document.getElementById(id); if(!el) return; el.classList.toggle('btn-disabled',!on); el.title = on? '': 'Carrega um Excel primeiro'; }); }

document.addEventListener('DOMContentLoaded',()=> setWbLoaded(!!state._wb));

// Importers
async function importProfessores(){ if(!state._wb) return toast('Carrega primeiro o ficheiro Excel'); const f=sheetBy(state._wb,['Professores','Docentes','Teachers']); if(!f) return Swal.fire('Erro','Sheet "Professores" n√£o encontrada','error'); const rows=rowsFrom(f.ws); const out=[]; for(const r of rows){ const idKey=guessCol(r,['id','professorid','codigo']); const nomeKey=guessCol(r,['nome','name']); const emailKey=guessCol(r,['email']); const roleKey=guessCol(r,['role','perfil']); const id=(r[idKey]||'').trim(); if(!RX_PROF_ID.test(id)) continue; out.push({id,nome:(r[nomeKey]||'').trim(),email:(r[emailKey]||'').trim(),role:(r[roleKey]||'')}); } if(!out.length) return toast('Nada para importar'); state.config.professores=out; await saveCfg(); renderAdminGrid(); toast('Professores importados'); }
async function importAlunos(){ if(!state._wb) return toast('Carrega primeiro o ficheiro Excel'); const f=sheetBy(state._wb,['Alunos','Students']); if(!f) return Swal.fire('Erro','Sheet "Alunos" n√£o encontrada','error'); const rows=rowsFrom(f.ws); const out=[]; for(const r of rows){ const idKey=guessCol(r,['id','codigo','alunoid']); const nomeKey=guessCol(r,['nome','name']); const numeroKey=guessCol(r,['numero','n¬∫','n']); const turmaKey=guessCol(r,['turma','classe']); const id=String(r[idKey]||'').trim(); if(!id) continue; out.push({id,nome:(r[nomeKey]||'').trim(),numero:(r[numeroKey]||'').trim(),turma:(r[turmaKey]||'').trim()}); } state.config.alunos=out; await saveCfg(); renderAdminGrid(); toast('Alunos importados'); }
async function importDisciplinas(){ if(!state._wb) return toast('Carrega primeiro o ficheiro Excel'); const f=sheetBy(state._wb,['Disciplinas','Subjects']); if(!f) return Swal.fire('Erro','Sheet "Disciplinas" n√£o encontrada','error'); const rows=rowsFrom(f.ws); const out=[]; for(const r of rows){ const idKey=guessCol(r,['id','codigo']); const nomeKey=guessCol(r,['nome','name']); const id=(r[idKey]||'').trim(); if(!id) continue; out.push({id: id.replace(/[ .]/g,''), nome:(r[nomeKey]||id).trim()}); } state.config.disciplinas=out; await saveCfg(); renderAdminGrid(); toast('Disciplinas importadas'); }
async function importAulas(){ if(!state._wb) return toast('Carrega primeiro o ficheiro Excel'); const f=sheetBy(state._wb,['Aulas','Oficinas','Sessions']); if(!f) return Swal.fire('Erro','Sheet "Aulas/Oficinas" n√£o encontrada','error'); const rows=rowsFrom(f.ws); const out=[]; for(const r of rows){ const pKey=guessCol(r,['professorid','prof','professor']); const dKey=guessCol(r,['disciplina','disciplinaid','disc']); const aKey=guessCol(r,['alunos','tokens','alunosservico']); const diaKey=guessCol(r,['dia','diasemana']); const hiKey=guessCol(r,['inicio','horainicio']); const hfKey=guessCol(r,['fim','horafim']); const salaKey=guessCol(r,['sala']); const profId=(r[pKey]||'').trim(); const disc=(r[dKey]||'').trim(); const dia=normDia(r[diaKey]||''); const hi=(r[hiKey]||'').trim(); const hf=(r[hfKey]||'').trim(); const tokens=String(r[aKey]||'').split(/[\s,\.]+/).map(s=>s.trim()).filter(Boolean); if(!profId||!disc||!dia||!hi||!hf) continue; const id=genAulaId(profId,dia,hi,disc,tokens); out.push({id, professorId:profId, disciplinaId:disc.replace(/[ .]/g,''), alunoIds:tokens, diaSemana:dia, horaInicio:hi, horaFim:hf, sala:(r[salaKey]||'').trim()}); } const map=new Map(out.map(x=>[String(x.id),x])); state.config.oficinas=[...map.values()]; await saveCfg(); renderAdminGrid(); toast('Aulas importadas'); }

function findHorarioSheet(){ if(!state._wb) return null; return sheetBy(state._wb,['Horarios','Horario','Schedule']); }
async function gerarProfessores(){ const fh=findHorarioSheet(); if(!fh){ toast('Sheet Horarios n√£o encontrada'); return;} const rows=rowsFrom(fh.ws); const set=new Map(); rows.forEach(r=>{ const p=String(r[guessCol(r,['professorid','prof'])]||'').trim(); const nome=String(r[guessCol(r,['nome','professor'])]||'').trim(); if(RX_PROF_ID.test(p)) set.set(p,{id:p,nome,email:'',role:''}); }); if(!set.size) return toast('Nada encontrado'); state.config.professores=[...set.values()]; await saveCfg(); renderAdminGrid(); toast('Gerado a partir do Horario'); }
async function gerarDisciplinas(){ const fh=findHorarioSheet(); if(!fh){ toast('Sheet Horarios n√£o encontrada'); return;} const rows=rowsFrom(fh.ws); const set=new Map(); rows.forEach(r=>{ const d=String(r[guessCol(r,['disciplina','disc'])]||'').trim(); if(d) set.set(d.replace(/[ .]/g,''),{id:d.replace(/[ .]/g,''),nome:d}); }); state.config.disciplinas=[...set.values()]; await saveCfg(); renderAdminGrid(); toast('Disciplinas geradas'); }
async function gerarAlunos(){ const fh=findHorarioSheet(); if(!fh){ toast('Sheet Horarios n√£o encontrada'); return;} const rows=rowsFrom(fh.ws); const map=new Map(); rows.forEach(r=>{ const tok=String(r[guessCol(r,['alunos','tokens','alunosservico'])]||''); const arr=tok.split(/[\s,\.]+/).map(s=>s.trim()).filter(Boolean); arr.forEach(id=>{ if(RX_ALUNO.test(id)){ if(!map.has(id)) map.set(id,{id,nome:id,numero:'',turma:''}); } }); }); state.config.alunos=[...map.values()]; await saveCfg(); renderAdminGrid(); toast('Alunos gerados'); }
async function gerarAulas(){ const fh=findHorarioSheet(); if(!fh){ toast('Sheet Horarios n√£o encontrada'); return;} const rows=rowsFrom(fh.ws); const out=[]; rows.forEach(r=>{ const p=String(r[guessCol(r,['professorid','prof'])]||'').trim(); const d=String(r[guessCol(r,['disciplina','disc'])]||'').trim(); const dia=normDia(r[guessCol(r,['dia'])]||''); const tempo=String(r[guessCol(r,['tempo','horario','hora'])]||'').trim(); let hi='',hf=''; if(tempo.includes('-')){ [hi,hf]=tempo.split('-').map(s=>s.trim()); } else { hi=tempo; }
  const tok=String(r[guessCol(r,['alunos','tokens','alunosservico'])]||''); const arr=tok.split(/[\s,\.]+/).map(s=>s.trim()).filter(Boolean); if(!p||!d||!dia||!hi) return; const id=genAulaId(p,dia,hi,d,arr); out.push({id,professorId:p,disciplinaId:d.replace(/[ .]/g,''),alunoIds:arr,diaSemana:dia,horaInicio:hi,horaFim:hf||ESCOLA_TIMES.find(x=>x.startsWith(hi))?.split('-')[1]||hi,sala:''}); }); const map=new Map(out.map(x=>[String(x.id),x])); state.config.oficinas=[...map.values()]; await saveCfg(); renderAdminGrid(); toast('Aulas geradas'); }

// Normaliza√ß√£o
function cleanToken(x){ const t=String(x||'').trim().replace(/\.+/g,'').replace(/\s+/g,' '); const noAcc=t.normalize('NFD').replace(/[\u0300-\u036f]/g,''); return noAcc; }
function normalizeDisciplina(s){ return cleanToken(s).replace(/\s+/g,''); }
function normalizeService(s){ let v=cleanToken(s); const map={ 'NATACAO':'Natacao','NATAC':'Natacao','GESTPR':'GestPr','BOCCIA':'Boccia','DESPORTO':'Desporto','CJ':'CJ','CA':'CA','PM':'PM','PEI':'PEI','TP':'TP','APEE':'APEE','DT':'DT','AP':'AP','BE':'BE','SNZ':'SNZ' }; const key=(v.replace(/\s+/g,'').toUpperCase()); return map[key] || v.replace(/\s+/g,''); }

function genAulaId(profId, diaSemana, horaInicio, disciplinaId, alunoIds){ const HHMM=(horaInicio||'00:00').replace(':',''); const D=String(diaSemana); const disc=normalizeDisciplina(String(disciplinaId||'DISC')); const arr=Array.isArray(alunoIds)? alunoIds.filter(Boolean):[]; const toks=arr.map(x=> cleanToken(x)); const alunos=toks.filter(x=> RX_ALUNO.test(x) || STUDENT_LIKE.has(normalizeService(x)) ); const servs=toks.filter(x=> SERVICE_ONLY.has(normalizeService(x)) ).map(normalizeService); let tag=''; if(alunos.length && servs.length){ tag=`MIX-${alunos.length}-${servs.join('+')}`; } else if(alunos.length){ tag=`AL${alunos.length}`; } else if(servs.length){ tag=`FUNC-${servs.join('+')}`; } else { tag='FUNC'; } return `${profId}-${D}-${HHMM}-${disc}-${tag}`; }
function deriveProfessorIdFromAulaId(aulaId){ const s=String(aulaId??'').trim(); const m=s.match(RX_PROF_ID); return m? m[0] : ''; }
function normDia(v){ const s=String(v??'').trim(); if(/^\d+$/.test(s)) return Number(s); const i=DIAS.findIndex(d=> d.toLowerCase()===s.toLowerCase()); return i>=0? i+1 : 0; }

function renderAdminGrid(){ const entity=$('#adminEntity')?.value??'professores'; state.adminSel.entity=entity; state.adminSel.index=-1; const t=$('#adminGrid'); if(!t) return; const data=g(entity)??[]; const schema=ADMIN_SCHEMAS[entity]??[]; const vis=schema.filter(x=>x.key!=='_hor'); const th=vis.map(x=>`<th>${esc(x.label)}</th>`).join(''); const rows=data.map((row,i)=>`<tr data-index='${i}'>${vis.map(x=>`<td>${esc(Array.isArray(row[x.key])?row[x.key].join(', '):(row[x.key]??''))}</td>`).join('')}${entity==='professores'?"<td><button class='btn btn-hor' data-hor='"+i+"'>Hor√°rio</button></td>":''}</tr>`).join(''); t.innerHTML=`<div style='overflow:auto'><table class='table'><thead><tr>${th}${entity==='professores'?'<th>Hor√°rio</th>':''}</tr></thead><tbody>${rows||`<tr><td colspan='${vis.length+(entity==='professores'?1:0)}' class='muted'>Sem registos</td></tr>`}</tbody></table></div>`; t.querySelectorAll('tbody tr[data-index]').forEach(tr=>{tr.addEventListener('click',ev=>{ if(ev.target?.hasAttribute('data-hor')) return; t.querySelectorAll('tbody tr').forEach(x=>x.classList.remove('selected')); tr.classList.add('selected'); state.adminSel.index=Number(tr.getAttribute('data-index')); updateAdminBtns(); });}); t.querySelectorAll('[data-hor]').forEach(b=> b.addEventListener('click',()=> openHorarioEditor(Number(b.getAttribute('data-hor'))) )); updateAdminBtns(); makeSortableTable('#adminGrid table'); }
function updateAdminBtns(){ const on=state.adminSel.index>=0; $('#btnAdminEditar')?.toggleAttribute('disabled',!on); $('#btnAdminApagar')?.toggleAttribute('disabled',!on); }

const ADMIN_SCHEMAS={
  professores:[{key:'id',label:'ID (ex.: 910EE07)',type:'text',required:true},{key:'nome',label:'Nome',type:'text',required:true},{key:'email',label:'Email',type:'email',required:true},{key:'role',label:'Role',type:'select',options:['','admin']},{key:'_hor',label:'Hor√°rio',type:'button'}],
  alunos:[{key:'id',label:'ID (ex.: 9C1 ou 811)',type:'text',required:true},{key:'nome',label:'Nome',type:'text',required:true},{key:'numero',label:'N√∫mero',type:'text'},{key:'turma',label:'Turma',type:'text'}],
  disciplinas:[{key:'id',label:'ID',type:'text',required:true},{key:'nome',label:'Nome',type:'text',required:true}],
  oficinas:[{key:'id',label:'ID da Aula (auto-sugerido)',type:'text',required:true,help:'Ser√° sugerido pelo editor/gerador'},{key:'professorId',label:'Professor',type:'select',required:true,optionsFrom:'professores'},{key:'disciplinaId',label:'Disciplina',type:'select',required:true,optionsFrom:'disciplinas'},{key:'alunoIds',label:'Alunos/Servi√ßo (IDs ou siglas, v√≠rgulas)',type:'textarea',required:true},{key:'diaSemana',label:'Dia da semana (1..5 ou texto)',type:'text',required:true},{key:'horaInicio',label:'Hora in√≠cio',type:'select',required:true,options:ESCOLA_TIMES.map(t=>t.split('-')[0])},{key:'horaFim',label:'Hora fim',type:'select',required:true,options:ESCOLA_TIMES.map(t=>t.split('-')[1])},{key:'sala',label:'Sala',type:'text'}]
};

function g(e){const c=state.config; if(e==='professores')return c.professores; if(e==='alunos')return c.alunos; if(e==='disciplinas')return c.disciplinas; if(e==='oficinas')return c.oficinas; return []}
function s(e,d){if(e==='professores')state.config.professores=d; if(e==='alunos')state.config.alunos=d; if(e==='disciplinas')state.config.disciplinas=d; if(e==='oficinas')state.config.oficinas=d;}

function makeAutocomplete(input, options){ const wrap=document.createElement('div'); wrap.style.position='relative'; input.parentNode.insertBefore(wrap,input); wrap.appendChild(input); const list=document.createElement('div'); list.style.cssText='position:absolute;left:0;right:0;background:var(--card);border:1px solid var(--primary-border);border-radius:10px;box-shadow:var(--shadow-sm);max-height:220px;overflow:auto'; list.classList.add('hidden'); wrap.appendChild(list); function render(q){ list.innerHTML=''; const s=q.trim().toLowerCase(); if(!s){ list.classList.add('hidden'); return; } const filtered=options.filter(o=> (o.id+' '+(o.nome??o.id)).toLowerCase().includes(s)).slice(0,30); if(!filtered.length){ list.classList.add('hidden'); return; } filtered.forEach(o=>{ const item=document.createElement('div'); item.className='ac-item'; item.textContent=`${o.id} ¬∑ ${o.nome??o.id}`; item.addEventListener('click',()=>{ input.value=o.id; list.classList.add('hidden'); input.dispatchEvent(new Event('change')); }); list.appendChild(item); }); list.classList.remove('hidden'); } input.addEventListener('input',()=>render(input.value)); input.addEventListener('blur',()=> setTimeout(()=>list.classList.add('hidden'),200)); }

async function openForm(entity, initial){ const schema=ADMIN_SCHEMAS[entity]??[]; let html=''; let helpMsgs={}; for(const f of schema){ if(f.type==='button') continue; const val=(initial?.[f.key]??''); if(f.help) helpMsgs[f.key]=f.help; if(f.type==='select'&&f.optionsFrom){ const list=g(f.optionsFrom).map(x=>({id:x.id,nome:x.nome??x.id})); const opts=list.map(o=>`<option value='${esc(o.id)}' ${String(val)===String(o.id)?'selected':''}>${esc(o.nome)}</option>`).join(''); html+=`<label style='display:block;text-align:left'>${esc(f.label)}<select id='fld_${esc(f.key)}' class='swal2-input'>${opts}</select></label>`; } else if(f.type==='select'&&f.options){ const opts=f.options.map(o=>`<option value='${esc(o)}' ${String(val)===String(o)?'selected':''}>${esc(o)}</option>`).join(''); html+=`<label style='display:block;text-align:left'>${esc(f.label)}<select id='fld_${esc(f.key)}' class='swal2-input'>${opts}</select></label>`; } else if(f.type==='textarea'){ const v=Array.isArray(val)?val.join(', '):(val??''); html+=`<label style='display:block;text-align:left'>${esc(f.label)}<textarea id='fld_${esc(f.key)}' class='swal2-textarea'>${esc(v)}</textarea><div id='tags_${esc(f.key)}' class='tagbar'></div><input id='ac_${esc(f.key)}' class='swal2-input' placeholder='Adicionar aluno (ID) ou servi√ßo (CA/PM/CJ)‚Ä¶'></label>`; } else { html+=`<label style='display:block;text-align:left'>${esc(f.label)}<input id='fld_${esc(f.key)}' class='swal2-input' type='text' value='${esc(val)}' placeholder='${esc(helpMsgs[f.key]??'')}'></label>`; } } html += `<div id='valMsg' class='validation'></div>`; const res=await Swal.fire({title:(initial?'Editar':'Novo')+` em ${entity}`, html, width: 760, showCancelButton:true, confirmButtonText:'Guardar', focusConfirm:false, didOpen:()=>{ if(entity==='oficinas'){ const ac=document.getElementById('ac_alunoIds'); const area=document.getElementById('fld_alunoIds'); const tags=document.getElementById('tags_alunoIds'); const alunos=(state.config.alunos??[]).map(a=>({id:a.id,nome:a.nome??a.id})); if(ac){ makeAutocomplete(ac,alunos); ac.addEventListener('change',()=>{ const id=ac.value.trim(); if(!id) return; const cur=area.value? area.value.split(',').map(s=>s.trim()).filter(Boolean):[]; if(!cur.includes(id)){ cur.push(id); area.value=cur.join(', '); const tg=document.createElement('span'); tg.className='tag'; tg.innerHTML=`${esc(id)} <span class='x' title='remover'>√ó</span>`; tg.querySelector('.x').addEventListener('click',()=>{ tg.remove(); const rest=(area.value.split(',').map(s=>s.trim()).filter(Boolean)).filter(z=>z!==id); area.value=rest.join(', '); }); tags.appendChild(tg);} ac.value=''; }); } } }, preConfirm:()=>{ const out={}; for(const f of (ADMIN_SCHEMAS[entity]??[])){ if(f.type==='button') continue; const el=document.getElementById('fld_'+f.key); let v=(el?.value??'').trim(); if(entity==='oficinas'&&f.key==='alunoIds'){ v=v? v.split(/[\s,\.]+/).map(s=>s.trim()).filter(Boolean):[]; } out[f.key]=v; } return out; }}); return res.value; }

async function adminNovo(){ const e=$('#adminEntity')?.value??'professores'; const list=g(e).slice(); const obj=await openForm(e,null); if(!obj) return; if(!obj.id){Swal.fire('Erro','Campo ID √© obrigat√≥rio.','error');return;} if(list.some(r=> String(r.id)===String(obj.id))){Swal.fire('Erro','ID duplicado.','error');return;} list.push(obj); s(e,list); await saveCfg(); renderAdminGrid(); toast('Criado'); }
async function adminEditar(){ const e=state.adminSel.entity; const idx=state.adminSel.index; if(idx<0) return; const list=g(e); const obj=await openForm(e,list[idx]); if(!obj) return; if(!obj.id){Swal.fire('Erro','Campo ID √© obrigat√≥rio.','error');return;} if(list.some((r,i)=> i!==idx && String(r.id)===String(obj.id))){Swal.fire('Erro','ID j√° existe.','error');return;} list[idx]=obj; s(e,list); await saveCfg(); renderAdminGrid(); toast('Atualizado'); }
async function adminApagar(){ const e=state.adminSel.entity; const idx=state.adminSel.index; if(idx<0) return; const list=g(e).slice(); const row=list[idx]; const ok=await Swal.fire({title:`Apagar ${e}`,text:`Confirma apagar ${row?.id}?`,icon:'warning',showCancelButton:true,confirmButtonText:'Apagar'}); if(!ok.isConfirmed) return; list.splice(idx,1); s(e,list); await saveCfg(); renderAdminGrid(); toast('Removido'); }

async function saveCfg(){ try{ setSync('üîÅ sincronizando...'); await gSaveWithParents(CFG_PATH,state.config); localStorage.setItem('esp_config',JSON.stringify(state.config)); setSync('üíæ guardado'); }catch(e){ console.warn('save',e); setSync('‚ö† offline'); localStorage.setItem('esp_config',JSON.stringify(state.config)); }}

async function openHorarioEditor(idx){ const prof=(state.config.professores??[])[idx]; if(!prof){ Swal.fire('Erro','Professor inv√°lido','error'); return; } const head=`<div style='margin-bottom:8px'><strong>${esc(prof.nome)}</strong> <span class='muted'>${esc(prof.id)} ‚Ä¢ ${esc(prof.email??'')}</span></div>`; const gridHead=`<div style='display:grid;grid-template-columns:120px repeat(5,1fr);gap:8px;font-weight:600'><div></div>${DIAS.map(d=>`<div>${esc(d)}</div>`).join('')}</div>`; const rows=ESCOLA_TIMES.map((t,ti)=>`<div style='display:grid;grid-template-columns:120px repeat(5,1fr);gap:8px'><div class='muted'>${esc(t)}</div>${DIAS.map((d,di)=>`<div class='cell' data-ti='${ti}' data-di='${di+1}' title='Adicionar aula neste tempo'>+</div>`).join('')}</div>`).join(''); await Swal.fire({title:'Definir Hor√°rio', html: head+gridHead+rows, width:900, showConfirmButton:false, showCloseButton:true, didOpen:()=>{ document.querySelectorAll('.swal2-container .cell').forEach(cell=>{ cell.addEventListener('click', async ()=>{ const ti=Number(cell.getAttribute('data-ti')); const di=Number(cell.getAttribute('data-di')); const discOpts=(state.config.disciplinas??[]).map(x=>`<option value='${esc(x.id)}'>${esc(x.nome??x.id)}</option>`).join(''); const html = `
        <label style='display:block;text-align:left'>Disciplina<select id='a_disc' class='swal2-input'>${discOpts}</select></label>
        <label style='display:block;text-align:left'>Alunos/Servi√ßo (IDs ou CA/PM/CJ)<textarea id='a_alunos' class='swal2-textarea' placeholder='9C1,8J5 ou CA,PM'></textarea></label>
        <label style='display:block;text-align:left'>Sala<input id='a_sala' class='swal2-input' placeholder='Sala'></label>
        <div class='muted'>Dia: ${DIAS[di-1]} ‚Ä¢ Tempo: ${ESCOLA_TIMES[ti]}</div>
        <div id='a_preview' class='muted' style='margin-top:6px'></div>`; const res=await Swal.fire({title:'Nova Aula', html, showCancelButton:true, confirmButtonText:'Adicionar', didOpen:()=>{ const discEl=document.getElementById('a_disc'); const alEl=document.getElementById('a_alunos'); const prev=document.getElementById('a_preview'); const horaI=ESCOLA_TIMES[ti].split('-')[0]; function updatePrev(){ const arr=(alEl.value||'').split(/[\s,\.]+/).map(s=>s.trim()).filter(Boolean); const id = genAulaId(prof.id, di, horaI, discEl.value, arr); prev.textContent = 'ID sugerido: '+id; } discEl.addEventListener('change',updatePrev); alEl.addEventListener('input',updatePrev); updatePrev(); }, preConfirm:()=>{ const disciplinaId=document.getElementById('a_disc').value; const alunoIds=(document.getElementById('a_alunos').value||'').split(/[\s,\.]+/).map(s=>s.trim()).filter(Boolean); const sala=document.getElementById('a_sala').value.trim(); const horaI=ESCOLA_TIMES[ti].split('-')[0]; const horaF=ESCOLA_TIMES[ti].split('-')[1]; const toMin = h=>{const [H,M]=h.split(':').map(Number); return H*60+M;}; const sI=toMin(horaI), sF=toMin(horaF); const clash=(state.config.oficinas||[]).some(x=> x.professorId===prof.id && Number(x.diaSemana)===di && (Math.max(toMin(x.horaInicio),sI) < Math.min(toMin(x.horaFim),sF)) ); if(clash){ Swal.showValidationMessage('Conflito de hor√°rio: existe uma aula que se sobrep√µe nesse tempo.'); return false; } return { disciplinaId, alunoIds, sala, horaI, horaF, di }; }}); if(!res.isConfirmed) return; const a={ id: genAulaId(prof.id, res.value.di, res.value.horaI, res.value.disciplinaId, res.value.alunoIds), professorId: prof.id, disciplinaId: res.value.disciplinaId, alunoIds: res.value.alunoIds, diaSemana: res.value.di, horaInicio: res.value.horaI, horaFim: res.value.horaF, sala: res.value.sala }; const map=new Map((state.config.oficinas??[]).map(x=>[String(x.id),x])); map.set(String(a.id), a); state.config.oficinas=[...map.values()]; await saveCfg(); renderAdminGrid(); toast('Aula adicionada'); }); }); }}); }

function exportXlsx(rows,name){ const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,XLSX.utils.json_to_sheet(rows),'Registos'); const bin=XLSX.write(wb,{bookType:'xlsx',type:'array'}); const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([bin],{type:'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'})); a.download=`${name}_${todayISO()}.xlsx`; a.click(); setTimeout(()=>URL.revokeObjectURL(a.href),1200); }
function exportPdf(rows,title){ if(!(window.jspdf && window.jspdf.jsPDF && window.jspdf.jsPDF.API && window.jspdf.jsPDF.API.autoTable)){ Swal.fire('Erro','jsPDF/autoTable n√£o dispon√≠vel','error'); return; } const doc=new window.jspdf.jsPDF({unit:'pt',format:'a4'}); doc.text(title,40,40); const head=[['Data','Aluno/Servi√ßo','Professor','Disciplina','N¬∫','Sum√°rio','Estado']]; const body=rows.map(r=>[r.data??'',r.alunoId??'',r.professorId??'',r.disciplinaId??'',r.numeroLicao??'',(r.sumario??'').slice(0,160),r.status??'']); doc.autoTable({startY:60, head, body, styles:{fontSize:9,cellWidth:'wrap'}, columnStyles:{5:{cellWidth:220}}}); doc.save(title.replace(/\s+/g,'_')+`.pdf`); }

function pickFiltersAndExport(context){ const cfg=state.config; const alunos=(cfg.alunos??[]).map(a=>({id:a.id,nome:a.nome??a.id})); const discs=(cfg.disciplinas??[]).map(d=>({id:d.id,nome:d.nome??d.id})); const profs=(cfg.professores??[]).map(p=>({id:p.id,nome:p.nome??p.id})); const html=`<div class='stack gap'>
  <label style='text-align:left'>De <input id='fltDe' type='date' class='swal2-input' style='width:220px'></label>
  <label style='text-align:left'>At√© <input id='fltAte' type='date' class='swal2-input' style='width:220px'></label>
  <label style='text-align:left'>Filtrar por <select id='fltTipo' class='swal2-input'><option value=''>‚Äî</option><option value='aluno'>Aluno</option><option value='disc'>Disciplina</option><option value='prof'>Professor</option></select></label>
  <label style='text-align:left'>ID/Nome <input id='fltId' class='swal2-input' placeholder='come√ßa a escrever‚Ä¶'></label>
  <label style='text-align:left'>Formato <select id='fltFmt' class='swal2-input'><option value='pdf'>PDF</option><option value='xlsx'>XLSX</option></select></label>`; Swal.fire({title:'Exportar filtrado', html, showCancelButton:true, confirmButtonText:'Exportar', didOpen:()=>{ const inp=document.getElementById('fltId'); const tipo=document.getElementById('fltTipo'); function attach(){ const t=tipo.value; inp.value=''; if(t==='aluno') makeAutocomplete(inp, alunos); else if(t==='disc') makeAutocomplete(inp, discs); else if(t==='prof') makeAutocomplete(inp, profs); } attach(); tipo.addEventListener('change', attach); }, preConfirm:()=>{ const de=document.getElementById('fltDe').value; const ate=document.getElementById('fltAte').value; const tipo=document.getElementById('fltTipo').value; const fld=document.getElementById('fltId').value.trim(); const fmt=document.getElementById('fltFmt').value; return {de,ate,tipo,fld,fmt}; }}).then(res=>{ if(!res.isConfirmed) return; const {de,ate,tipo,fld,fmt}=res.value; let rows=(state.reg.registos??[]); function inRange(d){ if(de && d<de) return false; if(ate && d>ate) return false; return true; } if(context==='prof'){ const email=getEmail(); const prof=(state.config.professores??[]).find(p=>(p.email??'').toLowerCase()===email); rows=rows.filter(r=> r.professorId===(prof?.id??'')); } if(de||ate) rows=rows.filter(r=> inRange(r.data??'')); if(tipo==='aluno'&&fld) rows=rows.filter(r=> (r.alunoId??'')===fld); if(tipo==='disc'&&fld) rows=rows.filter(r=> (r.disciplinaId??'')===fld); if(tipo==='prof'&&fld) rows=rows.filter(r=> (r.professorId??'')===fld); if(fmt==='xlsx') exportXlsx(rows, `registos_${context??'all'}`); else exportPdf(rows, `Registos ${context==='prof'?'(meus)':''}`); }); }

function nextNL(al,disc,prof){ if(!(RX_ALUNO.test(String(al)) || STUDENT_LIKE.has(normalizeService(String(al))))) return ''; const nums=(state.reg.registos??[]).filter(r=> r.alunoId===al && r.disciplinaId===disc && r.professorId===prof).map(r=>parseInt(r.numeroLicao,10)).filter(n=>!isNaN(n)); return (nums.length? Math.max(...nums)+1:1).toString(); }
function keyOf(r){ return `${r.data}\n${r.professorId}\n${r.disciplinaId}\n${r.alunoId}\n${r.sessaoId??''}`; }

async function saveOne(aulaId, alunoId, data, profId){ const a=(state.config.oficinas??[]).find(x=> String(x.id)===String(aulaId)); if(!a){ toast('Aula inv√°lida'); return; } const sum=($(`.sumario[data-a='${CSS.escape(aulaId)}'][data-al='${CSS.escape(alunoId)}']`)??{}).value??''; const nlec=($(`.nlec[data-a='${CSS.escape(aulaId)}'][data-al='${CSS.escape(alunoId)}']`)??{}).value?? nextNL(alunoId,a.disciplinaId, profId); const sts=($(`.sts[data-a='${CSS.escape(aulaId)}'][data-al='${CSS.escape(alunoId)}']`)??{}).value??'P'; const rec={ id:'R'+crypto.randomUUID(), data, professorId: profId, disciplinaId:a.disciplinaId, alunoId: alunoId, sessaoId:aulaId, numeroLicao:nlec, sumario:sum, status:sts, criadoEm:new Date().toISOString() }; const idx=(state.reg.registos??[]).findIndex(r=> keyOf(r)===keyOf(rec)); if(idx>=0) state.reg.registos[idx]={...state.reg.registos[idx], ...rec}; else state.reg.registos.push(rec); await saveReg(); toast('Registo guardado'); renderProfessor(); }

function renderProfessor(){ const email=getEmail(); const prof=(state.config.professores??[]).find(p=>(p.email??'').toLowerCase()===email); const sec=$('#secProfessor'); if(!account){ sec?.classList.add('hidden'); return; } sec?.classList.remove('hidden'); const data=$('#profData')?.value??todayISO(); if($('#profData')) $('#profData').value=data; const tbodyHoje=$('#tblHoje tbody'); tbodyHoje.innerHTML=''; if(!prof){ tbodyHoje.innerHTML='<tr><td colspan="7" class="muted">Sem correspond√™ncia do seu email nos Professores.</td></tr>'; return; } const dow=(new Date(data).getDay()+6)%7+1; const aulas=(state.config.oficinas??[]).filter(a=> a.professorId===prof.id && Number(a.diaSemana)===Number(dow)); const disc=Object.fromEntries((state.config.disciplinas??[]).map(d=>[String(d.id),d])); const aluno=Object.fromEntries((state.config.alunos??[]).map(a=>[String(a.id),a])); if(!aulas.length){ tbodyHoje.innerHTML='<tr><td colspan="7" class="muted">Sem aulas para este dia.</td></tr>'; }
  aulas.forEach(a=>{ const ids = Array.isArray(a.alunoIds)? a.alunoIds:[]; ids.forEach(al=>{ const tr=document.createElement('tr'); const next=nextNL(al,a.disciplinaId,prof.id); const isAluno = RX_ALUNO.test(String(al)) || STUDENT_LIKE.has(normalizeService(String(al))); tr.innerHTML = `
        <td>${esc(a.horaInicio)}‚Äì${esc(a.horaFim)}</td>
        <td>${esc(disc[a.disciplinaId]?.nome??a.disciplinaId)}</td>
        <td>${esc(al)} ${isAluno?('¬∑ '+esc(aluno[al]?.nome??al)) : ''}</td>
        <td><input class='input nlec' value='${esc(next)}' data-al='${esc(al)}' data-a='${esc(a.id)}' ${next?'' : 'disabled'}></td>
        <td><input class='input sumario' placeholder='Sum√°rio' data-al='${esc(al)}' data-a='${esc(a.id)}'></td>
        <td><select class='input sts' data-al='${esc(al)}' data-a='${esc(a.id)}'><option value='P'>P</option><option value='A'>A</option><option value='J'>J</option></select></td>
        <td class='actions-cell'><input type='checkbox' class='chk sel' data-al='${esc(al)}' data-a='${esc(a.id)}'><button class='btn btn-save' data-al='${esc(al)}' data-a='${esc(a.id)}'>Guardar</button></td>`; tbodyHoje.appendChild(tr); }); }); tbodyHoje.querySelectorAll('.btn-save').forEach(btn=> btn.addEventListener('click',()=> saveOne(btn.dataset.a, btn.dataset.al, data, prof.id) ) ); $('#btnSalvarSelecionados')?.addEventListener('click',()=>{ tbodyHoje.querySelectorAll('.sel:checked').forEach(chk=> saveOne(chk.dataset.a, chk.dataset.al, data, prof.id)); }); renderPendentes(prof, data); renderProfessorGrid(prof); }

function renderPendentes(prof, today){ const tbody=$('#tblPend tbody'); tbody.innerHTML=''; const start=state.config?.calendario?.anoLetivoInicio ?? (new Date().getFullYear()+'-09-01'); const have=new Set((state.reg.registos??[]).map(r=> keyOf(r) )); const aulas=(state.config.oficinas??[]).filter(a=> a.professorId===prof.id); const aluno=Object.fromEntries((state.config.alunos??[]).map(a=>[String(a.id),a])); aulas.forEach(a=>{ let d=new Date(start); const end=new Date(today); for(; d<=end; d.setDate(d.getDate()+1)){ const dow=(d.getDay()+6)%7+1; if(Number(a.diaSemana)!==dow) continue; const ds=d.toISOString().slice(0,10); const ids = Array.isArray(a.alunoIds)? a.alunoIds:[]; ids.forEach(al=>{ const k=keyOf({data:ds,professorId:prof.id,disciplinaId:a.disciplinaId,alunoId:al,sessaoId:a.id}); if(!have.has(k)){ const tr=document.createElement('tr'); tr.innerHTML = `<td>${esc(ds)}</td><td>${esc(a.disciplinaId)}</td><td>${esc(al)} ${RX_ALUNO.test(String(al))?('¬∑ '+esc(aluno[al]?.nome??al)) : ''}</td><td><button class='btn btn-pendente' data-a='${esc(a.id)}' data-al='${esc(al)}' data-d='${esc(ds)}'>Registar</button></td>`; tbody.appendChild(tr); } }); }}); if(!tbody.children.length){ tbody.innerHTML='<tr><td colspan="4" class="muted">Sem pendentes.</td></tr>'; } tbody.querySelectorAll('.btn-pendente').forEach(btn=> btn.addEventListener('click',async ()=>{ const aulaId=btn.dataset.a; const al=btn.dataset.al; const data=btn.dataset.d; const a=(state.config.oficinas??[]).find(x=> String(x.id)===String(aulaId)); if(!a) return; const next=nextNL(al,a.disciplinaId,prof.id); const html = `<label style='display:block;text-align:left'>N¬∫ Li√ß√£o<input id='p_n' class='swal2-input' value='${esc(next)}' ${next?'':'disabled'}></label><label style='display:block;text-align:left'>Sum√°rio<input id='p_s' class='swal2-input' placeholder='Sum√°rio'></label><label style='display:block;text-align:left'>Presen√ßa<select id='p_st' class='swal2-input'><option value='P'>P</option><option value='A'>A</option><option value='J'>J</option></select></label>`; const r=await Swal.fire({title:`Registar ${esc(data)}`, html, showCancelButton:true, confirmButtonText:'Guardar'}); if(!r.isConfirmed) return; const rec={ id:'R'+crypto.randomUUID(), data, professorId: prof.id, disciplinaId:a.disciplinaId, alunoId: al, sessaoId:aulaId, numeroLicao: (document.getElementById('p_n').value??next), sumario: (document.getElementById('p_s').value??''), status: (document.getElementById('p_st').value??'P'), criadoEm:new Date().toISOString() }; const idx=(state.reg.registos??[]).findIndex(rr=> keyOf(rr)===keyOf(rec)); if(idx>=0) state.reg.registos[idx]={...state.reg.registos[idx], ...rec}; else state.reg.registos.push(rec); await saveReg(); toast('Registo criado'); renderProfessor(); }) ); }

async function saveReg(){ try{ setSync('üîÅ sincronizando...'); await gSaveWithParents(REG_PATH,state.reg); localStorage.setItem('esp_reg',JSON.stringify(state.reg)); setSync('üíæ guardado'); }catch(e){ setSync('‚ö† offline'); localStorage.setItem('esp_reg',JSON.stringify(state.reg)); }}

function diag(){ const el=$('#diagInfo'); const why=$('#adminGateInfo'); const email=getEmail(); if(el) el.innerHTML=`SITE_ID: <code>${esc(SITE_ID)}</code><br>CFG_PATH: <code>${esc(CFG_PATH)}</code><br>REG_PATH: <code>${esc(REG_PATH)}</code>`; if(why){ let reason='n√£o admin'; if(ALLOWLIST.includes(email)) reason='allow-list'; else { const prof=(state.config?.professores??[]).find(p=> (p.email??'').toLowerCase()===email); if(prof && String(prof.role??'').toLowerCase()==='admin') reason='role=admin (config)'; } why.textContent=`Utilizador: ${email??'-'} ‚Ä¢ Perfil: ${isAdmin()?'Admin':'Professor'} ‚Ä¢ Gate: ${reason}`; } }

$('#btnDiagCreateFolders')?.addEventListener('click',async()=>{ try{ await ensureFolder(pdir(CFG_PATH)); await ensureFolder(pdir(REG_PATH)); toast('Pastas OK'); }catch(e){ Swal.fire('Erro','Falha ao criar pastas: '+e.message,'error'); } });
$('#btnDiagListFolder')?.addEventListener('click',async()=>{ try{ if(!accessToken) await acquire(); const folder=pdir(CFG_PATH); const r=await fetch(`https://graph.microsoft.com/v1.0/sites/${SITE_ID}/drive/root:${folder}:/children`,{headers:{Authorization:`Bearer ${accessToken}`}}); const j=await r.json(); Swal.fire({title:'Conte√∫do da pasta',html:`<pre style='text-align:left;white-space:pre-wrap'>${esc(JSON.stringify(j,null,2))}</pre>`,width:800}); }catch(e){ Swal.fire('Erro','Listagem falhou: '+e.message,'error'); } });
$('#btnDiagClearCache')?.addEventListener('click',()=>{ localStorage.removeItem('esp_config'); localStorage.removeItem('esp_reg'); toast('Cache local limpa'); });
$('#btnDiagInitFiles')?.addEventListener('click', async ()=>{ try{ const cfg={professores:[],alunos:[],disciplinas:[],oficinas:[],calendario:{}}; const reg={versao:'v2',registos:[]}; setSync('üîÅ a inicializar...'); await gSaveWithParents(CFG_PATH,cfg); await gSaveWithParents(REG_PATH,reg); state.config=cfg; state.reg=reg; setSync('üíæ guardado'); renderAdminGrid(); renderProfessor(); toast('Ficheiros inicializados'); }catch(e){ Swal.fire('Erro','Falha a inicializar: '+e.message,'error'); }});

// Bind Admin Import/Generate actions & file input
$('#fileExcel')?.addEventListener('change', async ()=>{ setWbLoaded(false); const f=$('#fileExcel').files?.[0]; if(!f){ toast('Nenhum ficheiro'); return;} try{ state._wb=await loadWorkbook(f); state._wbName=f.name; toast('Workbook carregado'); setWbLoaded(true); }catch(e){ Swal.fire('Erro','N√£o foi poss√≠vel ler o Excel: '+e.message,'error'); } });
$('#btnWbInfo')?.addEventListener('click',()=>{ if(!state._wb) return toast('Sem workbook'); const names=state._wb.SheetNames.join(', '); Swal.fire('Workbook','Sheets: '+names,'info'); });
$('#btnImpProf')?.addEventListener('click',()=>importProfessores());
$('#btnImpAlu')?.addEventListener('click',()=>importAlunos());
$('#btnImpDisc')?.addEventListener('click',()=>importDisciplinas());
$('#btnImpAulas')?.addEventListener('click',()=>importAulas());
$('#btnGenProf')?.addEventListener('click',()=>gerarProfessores());
$('#btnGenAlu')?.addEventListener('click',()=>gerarAlunos());
$('#btnGenDisc')?.addEventListener('click',()=>gerarDisciplinas());
$('#btnGenAulas')?.addEventListener('click',()=>gerarAulas());

function makeSortableTable(tblSel){ const tbl=document.querySelector(tblSel); if(!tbl) return; const ths=tbl.querySelectorAll('thead th'); ths.forEach((th,idx)=>{ th.style.cursor='pointer'; th.addEventListener('click',()=>{ const tbody=tbl.querySelector('tbody'); const rows=[...tbody.querySelectorAll('tr')]; const asc = th.getAttribute('data-sort')!=='asc'; rows.sort((a,b)=>{ const ta=(a.children[idx]?.innerText||'').toLowerCase(); const tb=(b.children[idx]?.innerText||'').toLowerCase(); return asc? ta.localeCompare(tb): tb.localeCompare(ta); }); ths.forEach(x=>x.removeAttribute('data-sort')); th.setAttribute('data-sort', asc?'asc':'desc'); rows.forEach(r=>tbody.appendChild(r)); }); }); }

function tipoClassFor(a){ const arr=Array.isArray(a.alunoIds)? a.alunoIds:[]; const hasAl=arr.some(x=> RX_ALUNO.test(String(x)) || STUDENT_LIKE.has(normalizeService(String(x))) ); const hasSvc=arr.some(x=> SERVICE_ONLY.has(normalizeService(String(x))) ); if(hasAl && hasSvc) return 'pill-mix'; if(hasAl) return 'pill-al'; if(hasSvc) return 'pill-func'; return 'pill-func'; }
function renderProfessorGrid(prof){ const host=$('#gridProfHorario'); const sec=$('#secProfHorario'); if(!host||!sec) return; if(!prof){ sec.classList.add('hidden'); host.innerHTML=''; return; } sec.classList.remove('hidden'); let html = `<div class='hor-grid'><div></div>${DIAS.map(d=>`<div>${esc(d)}</div>`).join('')}</div>`; ESCOLA_TIMES.forEach((t,ti)=>{ html += `<div class='hor-grid'><div class='muted'>${esc(t)}</div>`; for(let di=1;di<=5;di++){ const aulas=(state.config.oficinas||[]).filter(a=> a.professorId===prof.id && Number(a.diaSemana)===di && a.horaInicio===t.split('-')[0]); if(!aulas.length){ html += `<div class='hor-cell muted'>‚Äî</div>`; } else{ const txt=aulas.map(a=>{ const disc=(state.config.disciplinas||[]).find(x=> String(x.id)===String(a.disciplinaId)); const label=disc?disc.nome:a.disciplinaId; const who=(Array.isArray(a.alunoIds)?a.alunoIds:[]).join(' '); const tipo=tipoClassFor(a); return `<span class='pill ${tipo}'>${esc(label)}</span><br><span class='muted' style='font-size:12px'>${esc(who)}</span>`; }).join('<hr style="border:none;border-top:1px solid var(--primary-border);margin:6px 0">'); html += `<div class='hor-cell'>${txt}</div>`; } } html += `</div>`; }); host.innerHTML = html; }

$('#adminEntity')?.addEventListener('change',()=>renderAdminGrid());
$('#btnAdminNovo')?.addEventListener('click',()=>adminNovo());
$('#btnAdminEditar')?.addEventListener('click',()=>adminEditar());
$('#btnAdminApagar')?.addEventListener('click',()=>adminApagar());
$('#btnAdminExportLista')?.addEventListener('click',()=>{ const e=$('#adminEntity')?.value??'professores'; exportXlsx(g(e),(e==='oficinas'?'Aulas':e)); });
$('#btnExportRegXlsx')?.addEventListener('click',()=> exportXlsx((state.reg.registos??[]),'registos') );
$('#btnExportRegPdf')?.addEventListener('click',()=> exportPdf((state.reg.registos??[]),'Registos') );
$('#btnExportFiltrado')?.addEventListener('click',()=> pickFiltersAndExport('admin'));
$('#profData')?.addEventListener('change',()=>renderProfessor());
$('#btnProfHoje')?.addEventListener('click',()=>{ if($('#profData')) $('#profData').value=todayISO(); renderProfessor(); });
$('#btnProfExportXLSX')?.addEventListener('click',()=>{ const email=getEmail(); const prof=(state.config.professores??[]).find(p=>(p.email??'').toLowerCase()===email); if(!prof) return toast('Sem professor associado'); const rows=(state.reg.registos??[]).filter(r=> r.professorId===prof.id); exportXlsx(rows,`meus_registos_${prof.id}`); });
$('#btnProfExportPDF')?.addEventListener('click',()=>{ const email=getEmail(); const prof=(state.config.professores??[]).find(p=>(p.email??'').toLowerCase()===email); if(!prof) return toast('Sem professor associado'); const rows=(state.reg.registos??[]).filter(r=> r.professorId===prof.id); exportPdf(rows,`Meus registos ${prof.id}`); });
$('#btnProfExportFiltros')?.addEventListener('click',()=> pickFiltersAndExport('prof'));
$('#btnMsLogin')?.addEventListener('click',()=>doLogin());
$('#btnMsLogout')?.addEventListener('click',()=>doLogout());

(async function(){ await initMsal(); const c=localStorage.getItem('esp_config'); if(c) try{ state.config=JSON.parse(c);}catch{} const r=localStorage.getItem('esp_reg'); if(r) try{ state.reg=JSON.parse(r);}catch{} await loadAll(); })();
